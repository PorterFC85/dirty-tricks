name: Build and Publish Release ZIP

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  package-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build addon zip
        run: |
          set -euo pipefail

          ADDON_NAME="Dirty-Tricks"
          TAG_NAME="${GITHUB_REF_NAME}"
          VERSION="${TAG_NAME#v}"

          rm -rf dist
          mkdir -p "dist/${ADDON_NAME}"

          cp "Dirty-Tricks.toc" "dist/${ADDON_NAME}/"
          cp "Core.lua" "dist/${ADDON_NAME}/"
          cp "Settings.lua" "dist/${ADDON_NAME}/"
          cp "Profiles.lua" "dist/${ADDON_NAME}/"
          cp "SecureButtons.lua" "dist/${ADDON_NAME}/"
          cp "LICENSE" "dist/${ADDON_NAME}/"

          cd dist
          zip -r "../${ADDON_NAME}-${VERSION}.zip" "${ADDON_NAME}"

      - name: Publish GitHub release asset
        uses: softprops/action-gh-release@v2
        with:
          files: Dirty-Tricks-*.zip
          generate_release_notes: true
